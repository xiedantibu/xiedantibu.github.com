<!DOCTYPE html><!-- saved from url=(0057)http://www.cplusplus.com/forum/windows/143872/default.htm --><meta http-equiv="X-UA-Compatible" content="IE=Edge" />

<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Run C++ Console in Vb.net ? - C++ Forum</title>
<link rel="shortcut icon" type="image/x-icon" href="../../../favicon.ico">
<link rel="stylesheet" type="text/css" href="../../../v321/main.css">
<script src="../../../v321/main.js" type="text/javascript"></script>
</head>
<body>
<div id="I_top">
<div id="I_header">
<div id="I_logo"><a href="../../../default.htm" title="cplusplus.com"><div></div></a></div>
<div id="I_search">
<form id="search" action="/search.do" method="get">
Search: <input name="q" size="20" class="txt"> <input type="submit" value="Go" class="btn">
</form>
</div>
<div id="I_bar">
<ul>
<li><a href="../../default.htm">Forum</a></li>
<li><a href="../default.htm">Windows Programming</a></li>
<li class="here">Run C++ Console in Vb.net ?</li>
</ul>
</div>
<div id="I_user" class="C_LoginBox"><span title="ajax"></span></div>
</div>
</div>
<div id="I_mid">
<div id="I_wrap">
<div id="I_minheight"></div>
<div id="I_main">
<div class="C_support"><script type="text/javascript"><!--
if (!cookieGet("hspt31")) {
  document.write('<div class="C_DonateBox"></div>');
}
//-->
</script><div class="C_ad728"><script type="text/javascript"><!--
google_ad_client = "ca-pub-7688470879129516";
google_ad_slot = "7973859818";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<acript type="text/javascript"
src="../../../../pagead2.googlesyndication.com/pagead/show_ads.js">
</script></div><div class="C_supportbottom"></div></div><div id="I_content">
<h3><div class="C_ico default" title="post">&nbsp;</div> Run C++ Console in Vb.net ?</h3><span id="CH_edttl"></span><span class="rootdatPost" title="143872,root,0,-1,12,0"></span><div id="CH_PostList"><div class="C_forPost" id="msg758818"><span title="758818,152539,1023,11,1"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg758818" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTm7702360703" title="Thu, 02 Oct 2014 23:35:21 +0000"></span><script type="text/javascript">WhenId('CH_zTm7702360703');</script><noscript>Oct 2, 2014 at 11:35pm UTC</noscript></div>
<div class="dwho"><a href="../../../user/taipscode/default.htm"><b>taipscode</b> (11)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i758818">
 Hello everybody.<br>
<br>
Can make .dll with VS C++2012 console and import to vb.net2012?<br>
<br>
Thankyou very much.<br>
<br>
<br>
<br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn758818"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg759817"><span title="759817,13185,1023,1084,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg759817" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTme2bc94768d" title="Sun, 05 Oct 2014 13:46:38 +0000"></span><script type="text/javascript">WhenId('CH_zTme2bc94768d');</script><noscript>Oct 5, 2014 at 1:46pm UTC</noscript></div>
<div class="dwho"><a href="../../../user/freddie1/default.htm"><b>freddie1</b> (1084)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i759817">
My vb.net is pretty weak, but there's System InterOp Services (SysInvoke or whatever, I forget), where you can call Windows Api Functions and oter functions in dlls.  That should work.  In my case, I've used my ActiveX Grid Control in VB.NET.  That works fine.  Actually, the one I tested was written in PowerBASIC, but last year I rewrote it in C++ just for the h*** of it.  Don't recall if I tested that in VB.NET or not.  But my opinion is you should be able to do it.  Start by just making a small test project, like adding two numbers, and see if you can get it to work.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn759817"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg760117"><span title="760117,152539,1023,11,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg760117" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTm1af4a2d743" title="Mon, 06 Oct 2014 07:50:44 +0000"></span><script type="text/javascript">WhenId('CH_zTm1af4a2d743');</script><noscript>Oct 6, 2014 at 7:50am UTC</noscript></div>
<div class="dwho"><a href="../../../user/taipscode/default.htm"><b>taipscode</b> (11)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i760117">
 Hello Freddie1.<br>
 <br>
Can you make .dll by VC++2012 with Console and import to Vb.net 2012 with winform .<br>
<br>
Thankyou very much.
</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm90dd8e53a7" title="Mon, 06 Oct 2014 07:51:16 +0000"></span><script type="text/javascript">WhenId('CH_zTm90dd8e53a7');</script><noscript>Oct 6, 2014 at 7:51am UTC</noscript></span>
<span class="dbtn" id="CH_btn760117"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg760283"><span title="760283,13185,1023,1084,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg760283" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTm6b93bc98c5" title="Mon, 06 Oct 2014 17:34:24 +0000"></span><script type="text/javascript">WhenId('CH_zTm6b93bc98c5');</script><noscript>Oct 6, 2014 at 5:34pm UTC</noscript></div>
<div class="dwho"><a href="../../../user/freddie1/default.htm"><b>freddie1</b> (1084)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i760283">
I'm almost sure you can...<br>
<br>
<a href="../../../../msdn.microsoft.com/en-us/library/eyzhw3s8.aspx">http://msdn.microsoft.com/en-us/library/eyzhw3s8.aspx</a><br>
<br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn760283"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg760575"><span title="760575,152539,1023,11,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg760575" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTm62a330f048" title="Tue, 07 Oct 2014 07:32:54 +0000"></span><script type="text/javascript">WhenId('CH_zTm62a330f048');</script><noscript>Oct 7, 2014 at 7:32am UTC</noscript></div>
<div class="dwho"><a href="../../../user/taipscode/default.htm"><b>taipscode</b> (11)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i760575">
Thanks Freddie1<br>
But i need more details with step by step !!!!!!!!!!!!!!!!!!
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn760575"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg760603"><span title="760603,13185,1023,1084,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg760603" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTme37c611eb9" title="Tue, 07 Oct 2014 11:36:41 +0000"></span><script type="text/javascript">WhenId('CH_zTme37c611eb9');</script><noscript>Oct 7, 2014 at 11:36am UTC</noscript></div>
<div class="dwho"><a href="../../../user/freddie1/default.htm"><b>freddie1</b> (1084)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i760603">
Geeez!  What ever happened to figuring things out for oneself?  When I wanted to do that years ago I did a search for PInvoke, if I recall correctly.  That stands for 'Platform Invoke'.  It means you want to do something 'outside' of the .NET Framework.  Like call a Windows Api function, or native code in a C++ dll like you want to do.  When I got my search results back from MSDN I think, there was a short five or ten line code blurb showing how to do it.  At the time I was working with PowerBASIC instead of C++ but that doesn't matter a bit.  PowerBASIC makes native 32 bit exes or dlls.  So I made a dll exporting a function that returns an int where one passes in one int through the parameters.  I named the function AddOne(int iNumber);  It worked perfectly.  That's all you have to do.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn760603"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg761174"><span title="761174,13185,1023,1084,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg761174" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTm40bbc8b62c" title="Wed, 08 Oct 2014 19:13:08 +0000"></span><script type="text/javascript">WhenId('CH_zTm40bbc8b62c');</script><noscript>Oct 8, 2014 at 7:13pm UTC</noscript></div>
<div class="dwho"><a href="../../../user/freddie1/default.htm"><b>freddie1</b> (1084)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i761174">
Taipscode, do you still need help?  I'm sorry about my aweful reply above.  What happened is I'm kind of old, and so is my wife.  We're both 62.  Yesterday morning about 5 AM she fell down the steps at our house.  Unbelievably enough, she wasn't hurt.  But I was pretty shaken up.  It was about a half hour after that I answered as above.  I shouldn't even have been on the internet.<br>
<br>
But in any case, I did work out an example in C++ and VB.net if you want it.  Let me know.<br>
<br>
Fred
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn761174"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg761278"><span title="761278,152539,1023,11,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg761278" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTm6f82256a52" title="Wed, 08 Oct 2014 23:23:18 +0000"></span><script type="text/javascript">WhenId('CH_zTm6f82256a52');</script><noscript>Oct 8, 2014 at 11:23pm UTC</noscript></div>
<div class="dwho"><a href="../../../user/taipscode/default.htm"><b>taipscode</b> (11)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i761278">
 Yeah hi Freddie1. You are really a good friend.<br>
I ussually sick after read msdn.microsoft.com ,so i like more step by step ,hic hic....<br>
This is a code run good with VC++ Console 2012 , can you help me run on VB.net with winform .<br>
Thankyou very much , and i will send some gifts for you ,hic hic ....<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br></code></pre></td>
<td class="source"><pre><code><dfn>#include "stdafx.h"</dfn>
<dfn>#include &lt;EndpointVolume.h&gt;</dfn>
<dfn>#include "Audioclient.h"</dfn>
<dfn>#include &lt;mmdeviceapi.h&gt;</dfn>
<dfn>#include &lt;functiondiscoverykeys.h&gt;</dfn>

<dfn>#include "CmdLine.h"</dfn>

<dfn>#include &lt;mmdeviceapi.h&gt;</dfn>
<dfn>#include &lt;endpointvolume.h&gt;</dfn>

<var>int</var> main(<var>int</var> argc, CHAR* argv[])
{
 HRESULT hr=NULL;
    <var>bool</var> decibels = <var>false</var>;
    <var>bool</var> scalar = <var>false</var>;
    <var>double</var> newVolume=0.5;
 
    CoInitialize(NULL);
    IMMDeviceEnumerator *deviceEnumerator = NULL;
    hr = CoCreateInstance(__uuidof(MMDeviceEnumerator), NULL, CLSCTX_INPROC_SERVER, 
                          __uuidof(IMMDeviceEnumerator), (LPVOID *)&amp;deviceEnumerator);
    IMMDevice *defaultDevice = NULL;
 
    hr = deviceEnumerator-&gt;GetDefaultAudioEndpoint(eRender, eConsole, &amp;defaultDevice);
    deviceEnumerator-&gt;Release();
    deviceEnumerator = NULL;
 
    IAudioEndpointVolume *endpointVolume = NULL;
    hr = defaultDevice-&gt;Activate(__uuidof(IAudioEndpointVolume), 
         CLSCTX_INPROC_SERVER, NULL, (LPVOID *)&amp;endpointVolume);
    defaultDevice-&gt;Release();
    defaultDevice = NULL;
 
    <cite>// -------------------------</cite>
    <var>float</var> currentVolume = 0.8;
    endpointVolume-&gt;GetMasterVolumeLevel(&amp;currentVolume);
    printf(<kbd>"Current volume in dB is: %f\n"</kbd>, currentVolume);

    hr = endpointVolume-&gt;GetMasterVolumeLevelScalar(&amp;currentVolume);
    <cite>//CString strCur=L"";</cite>
    <cite>//strCur.Format(L"%f",currentVolume);</cite>
    <cite>//AfxMessageBox(strCur);</cite>

   
       <cite>// hr = endpointVolume-&gt;SetMasterVolumeLevel((float)newVolume, NULL);</cite>
  system(<kbd>"pause"</kbd>);
       hr = endpointVolume-&gt;SetMasterVolumeLevelScalar((<var>float</var>)newVolume, NULL);
   
    endpointVolume-&gt;Release();

	
    CoUninitialize();
 
    <var>return</var> FALSE;
	
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>

</div>
<div class="dhow">
<span class="sedited">Last edited on <span id="CH_zTm807d1ec81e" title="Wed, 08 Oct 2014 23:25:34 +0000"></span><script type="text/javascript">WhenId('CH_zTm807d1ec81e');</script><noscript>Oct 8, 2014 at 11:25pm UTC</noscript></span>
<span class="dbtn" id="CH_btn761278"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg761455"><span title="761455,13185,1023,1084,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg761455" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTm9e50b8b3ca" title="Thu, 09 Oct 2014 14:09:39 +0000"></span><script type="text/javascript">WhenId('CH_zTm9e50b8b3ca');</script><noscript>Oct 9, 2014 at 2:09pm UTC</noscript></div>
<div class="dwho"><a href="../../../user/freddie1/default.htm"><b>freddie1</b> (1084)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i761455">
First let me say Tapiscode, that I have been totally unable to get any of my examples working on 64 bit Windows 7.  When I first became interested in this topic of calling unmanaged code from VB.NET was back in 2008 or so.  And at that time I was using PowerBASIC for my tests.  PowerBASIC isn’t anything at all like VB.NET.  Its much closer to C or C++ than .NET.  So what my code works on at this point is Windows XP or 32 bit Windows 7.  I’m simply not knowledgable enough in .NET to know why my code won’t work on 64 bit machines, so I’m going to have to leave that up to you to figure out.<br>
<br>
The Microsoft link I used to learn what I did is this …<br>
<br>
<a href="../../../../msdn.microsoft.com/en-us/library/42b9ea93%28vvs.110%29.aspx">http://msdn.microsoft.com/en-us/library/42b9ea93%28v=vs.110%29.aspx</a><br>
<br>
It uses a MessageBox() example.  MessageBox() is the Win32/64 function in the Windows Api.  What I did was create the following PowerBASIC Dll…<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br></code></pre></td>
<td class="source"><pre><code><dfn>#Compile Dll</dfn>

Function AddOne Alias <kbd>"AddOne"</kbd> (Byval x As Long) Export As Long
  AddOne = x + 1
End Function</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
The function is called AddOne(), and all it does is increment and return the ‘x’ parameter passed in the parameter list.  In other words, if you pass in 5 it returns 6.<br>
<br>
Here is my VB.NET program that creates a GUI Window and calls AddOne() from the PowerBASIC Dll…<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br></code></pre></td>
<td class="source"><pre><code><kbd>'vbc /r:System.dll,System.Windows.Forms.dll,System.Drawing.dll /t:winexe PInvoke.vb
Imports System
Imports System.Drawing
Imports System.Windows.Forms
Imports System.Runtime.InteropServices

Public Class PowerBasic
  Declare Function AddOne Lib "ADDONE.DLL" Alias "AddOne" (Byval x As Long) As Integer   
End Class

Class PInvoke
  Inherits Form
  
  Sub New()
    Me.Text="Using PowerBASIC In VB.NET"    
    Me.BackColor = SystemColors.Window
    Me.ForeColor = SystemColors.WindowText
  End Sub
  
  Protected Overrides Sub OnPaint(ByVal pea As PaintEventArgs)
    Dim br As SolidBrush
    Dim iNum As Integer

    iNum=5
    iNum=PowerBasic.AddOne(5)
    br=New SolidBrush(SystemColors.WindowText)
    pea.Graphics.DrawString("iNum=" &amp; iNum.ToString(),Me.Font,br,0,0)
  End Sub
End Class

Module Main
  Sub Main()
    Application.Run(New PInvoke())
  End Sub
End Module </kbd></code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
Note that the key to doing this is the three lines at top as so…<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br></code></pre></td>
<td class="source"><pre><code>Public Class PowerBasic
  Declare Function AddOne Lib <kbd>"ADDONE.DLL"</kbd> Alias <kbd>"AddOne"</kbd> (Byval x As Long) As Integer   
End Class</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
As my link above describes, you have to wrap a VB Declare Statement within a ‘Class’, and I arbitrarily named the Class PowerBASIC.  And you can see in the OnPaint() message handler for my Pinvoke Class how I called the function, and I used the DrawString member of the Graphics Class to output the incremented number to the form.  This works perfectly on XP or 32 bit Windows 7.<br>
<br>
Note I don’t use the Visual Studio IDE to compile .NET programs.  Basically I dislike Visual Studio and I hate .NET.  I compiled the above program from the command line using vbc.exe which is the VB.NET compiler.  On my computer it can be found here…<br>
<br>
C:\Windows\Microsoft.NET\Framework\v3.0<br>
C:\Windows\Microsoft.NET\Framework\v3.5<br>
C:\Windows\Microsoft.NET\Framework\v4….<br>
Etc.<br>
<br>
To compile I make a batch file like so …<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br></code></pre></td>
<td class="source"><pre><code>CD\
CD C:\Code\MS.NET\vb.net\PInvoke
Path C:\Windows\Microsoft.net\framework\v3.5
cls
C:\Windows\system32\cmd.exe
Cls</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
In my case above my project directory where I’m working on this stuff is…<br>
<br>
C:\Code\MS.NET\vb.net\Pinvoke<br>
<br>
What the above code blurb does is change the current directory to my project directory, and add a temporary PATH to the vbc compiler, so that when I try to compile the system can find vbc.  Here is the command line to compile the above vb.net program if the file is named Pinvoke.vb and it is in the above directory…<br>
<br>
<br>
vbc /r:System.dll,System.Windows.Forms.dll,System.Drawing.dll /t:winexe PInvoke.vb<br>
<br>
You can see I have that command line remmed out at the top of PInvoke.vb.  And like I said, that works perfectly.  But I had great reservations about getting that to work in C or C++ because of the Calling Convention issue.  I’ll discuss that next…<br>
<br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn761455"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg761464"><span title="761464,13185,1023,1084,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg761464" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTmde93513b44" title="Thu, 09 Oct 2014 14:37:49 +0000"></span><script type="text/javascript">WhenId('CH_zTmde93513b44');</script><noscript>Oct 9, 2014 at 2:37pm UTC</noscript></div>
<div class="dwho"><a href="../../../user/freddie1/default.htm"><b>freddie1</b> (1084)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i761464">
The issue is this….<br>
<br>
Both PowerBASIC and .NET I believe use a parameter passing convention known as Standard Call.  If you are familiar at all with Win32 coding you might have seen these entities around some functions …<br>
<br>
<br>
WINAPI<br>
CALLBACK<br>
<br>
These are #defines of the C/C++ __stdcall keyword.  So in C or C++ you can specify a function as __stdcall if you like, but the default calling convention of C or C++ is __cdecl or C Declaration.  The difference is whether the caller or the callee releases stack memory after a function call.  Otherwise these are very close.  So close, in fact, that even if the wrong calling convention is specified, it’ll still work – sort of.  What will happen is that there will be a small, almost un-noticable memory leak with each function call.  So anyway, I made the following C++ Dll to convert the PowerBAIC code above …<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br></code></pre></td>
<td class="source"><pre><code><var>extern</var> <kbd>"C"</kbd> __declspec(dllexport) <var>int</var> AddOne(<var>int</var> iNumber);    <cite>// Dll</cite>

<var>int</var> AddOne(<var>int</var> iNumber)
{
 <var>return</var> ++iNumber;
}</code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
That, when compiled into a dll with your favorite Windows C++ compiler, is the exact equivalent of the PowerBASIC function above, but because I didn’t specify an alternate calling convention, it will default to __cdecl.  Oh!  And by the way, I named the dll produced by the above code DllServer.dll.  And here is the above VB program modified to use that dll’s AddOne() C++ function …<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br></code></pre></td>
<td class="source"><pre><code>‘Pinvoke1.vb
<kbd>'vbc /r:System.dll,System.Windows.Forms.dll,System.Drawing.dll /t:winexe PInvoke1.vb
Imports System
Imports System.Drawing
Imports System.Windows.Forms
Imports System.Runtime.InteropServices

Public Class CPP
  Declare Function AddOne Lib "DllServer.dll" Alias "AddOne" (Byval x As Int32) As Int32   
End Class

Class PInvoke
  Inherits Form
  
  Sub New()
    Me.Text="Using C++ In VB.NET"    
    Me.BackColor = SystemColors.Window
    Me.ForeColor = SystemColors.WindowText
  End Sub
  
  Protected Overrides Sub OnPaint(ByVal pea As PaintEventArgs)
    Dim br As SolidBrush
    Dim iNum As Integer

    iNum=5
    iNum=CPP.AddOne(5)
    br=New SolidBrush(SystemColors.WindowText)
    pea.Graphics.DrawString("iNum=" &amp; iNum.ToString(),Me.Font,br,0,0)
  End Sub
End Class

Module Main
  Sub Main()
    Application.Run(New PInvoke())
  End Sub
End Module </kbd></code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
Note I named this program Pinvoke1.vb, and the command line compilation string is also above.  Naturally, I put DllServer.dll (my C++ dll) in that project directory too.  And that seems to work perfectly, even though I know for sure there is a calling convention mismatch.  Every call to that function will likely leak a few bytes.  So if its called millions of times in a loop there will surely be problems.  <br>
<br>
So I searched around in the .NET documentation to see if there is a way of dealing with this calling convention issue, and there is.  VB.NET has a concept known as ‘attributes’.  These can be prefaced to various .NET program statements to add additional information to them.  There is an attribute known as DllImport where one can specify a calling convention for an external function.  So here is the above program modified to specify the calling convention of the AddOne() function as __cdecl.  Its Pinvoke2…<br>
<br>
<div class="auto"><table class="snippet"><tr><td class="rownum"><pre><code>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br></code></pre></td>
<td class="source"><pre><code>‘Pinvoke2
<kbd>'vbc /r:System.dll,System.Windows.Forms.dll,System.Drawing.dll /t:winexe PInvoke2.vb
Imports System
Imports System.Drawing
Imports System.Windows.Forms
Imports System.Runtime.InteropServices

Class PInvoke
  Inherits Form
  
  &lt;DllImport("DllServer.dll", EntryPoint:="AddOne", CallingConvention:=CallingConvention.Cdecl)&gt; _ 
  Public Shared Function AddOne(Byval x As Int32) As Int32
  End Function

  Sub New()
    Me.Text="Using C++ In VB.NET"    
    Me.BackColor = SystemColors.Window
    Me.ForeColor = SystemColors.WindowText
  End Sub
  
  Protected Overrides Sub OnPaint(ByVal pea As PaintEventArgs)
    Dim br As SolidBrush
    Dim iNum As Integer

    iNum=5
    iNum=AddOne(5)
    br=New SolidBrush(SystemColors.WindowText)
    pea.Graphics.DrawString("iNum=" &amp; iNum.ToString(),Me.Font,br,0,0)
  End Sub
End Class

Module Main
  Sub Main()
    Application.Run(New PInvoke())
  End Sub
End Module </kbd></code></pre></td><td class="C_btnholder"></td></tr></table></div>
<br>
<br>
You can find information on this issue here…<br>
<br>
<a href="../../../../msdn.microsoft.com/en-us/library/aa984739%28vvs.71%29.aspx">http://msdn.microsoft.com/en-us/library/aa984739%28v=vs.71%29.aspx</a><br>
<br>
At this time I feel really bad I can’t get this working on 64 bit Windows 7 – even as just 32 bit binaries, but by and large, I think my treatment of this issue of calling C++ dll code from VB.NET is sound.  Its working for me just fine on XP and 32 bit Win 7 (I have that at work).  Maybe you can figure out the 64 bit Win 7 issue and let me know.  There is probably some setting I need to add to my command line compilation string or something.<br>
<br>
In terms of your code, I haven’t looked at it yet, but what I’ve provided should give you a start.  I’d first start by trying to get these simple dlls of mine working, then move up to your code.  Hope this helps!<br>
<br>

</div>
<div class="dhow">
<span class="dbtn" id="CH_btn761464"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg761890"><span title="761890,13185,1023,1084,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg761890" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTm5e0fe3e4f2" title="Fri, 10 Oct 2014 13:50:08 +0000"></span><script type="text/javascript">WhenId('CH_zTm5e0fe3e4f2');</script><noscript>Oct 10, 2014 at 1:50pm UTC</noscript></div>
<div class="dwho"><a href="../../../user/freddie1/default.htm"><b>freddie1</b> (1084)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i761890">
Figured out why my code wouldn't run on Windows 7!  I needed to add a /platform:x86 switch to my VB Command Line compilation string.  If the C++ Dll is an x86 one, then the vb program has to be told to only compile the ILSAM in the .exe file to x86 code.  For my PInvoke2.vb progam it should look like so ...<br>
<br>
vbc /r:System.dll,System.Windows.Forms.dll,System.Drawing.dll /platform:x86 /t:winexe PInvoke2.vb<br>
<br>
I figured to had to be something like that to work on 32 bit Win7 but not x64.
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn761890"></span>

</div>
</div>
</div>
<div class="C_forPost" id="msg762269"><span title="762269,152539,1023,11,0"></span>
<div class="box">
<div class="boxtop">
<div class="dwhen"><a href="#msg762269" title="Link to this post"><img src="../../../img/link.png" width="16" height="8"></a> <span id="CH_zTm671c8bcf98" title="Sat, 11 Oct 2014 12:29:47 +0000"></span><script type="text/javascript">WhenId('CH_zTm671c8bcf98');</script><noscript>Oct 11, 2014 at 12:29pm UTC</noscript></div>
<div class="dwho"><a href="../../../user/taipscode/default.htm"><b>taipscode</b> (11)</a></div>
</div>
<div class="dwhat" colspan="2" id="CH_i762269">
 Op!<br>
Hi Freddie1.<br>
<br>
 Can you help me run my code C++ in vb.net ?<br>
I had said , i alway sick after read msdn.microsoft.com hic hic...
</div>
<div class="dhow">
<span class="dbtn" id="CH_btn762269"></span>

</div>
</div>
</div>
</div><div class="rootinsMore"></div><div class="rootbtnMore"></div><div class="rootinsNew"></div><div class="rootbtnNew"></div><div id="CH_insNew"></div><div id="CH_reply">Registered users can post here. <a href="../../../user/default.htm">Sign in or register</a> to post.</div><div id="CH_subscription"></div><div class="rootedtNew"></div><script type="text/javascript">new for_PostList(143872,0,152539,0,'CH_PostList','CH_subscription','CH_reply','CH_insNew','CH_edttl','../../thread.cgi','../../post.cgi','../../myposts.cgi.htm',64,32,512,256,1024,16);</script></div>
<script type="text/javascript"><!--
google_ad_client = "ca-pub-7688470879129516";
google_ad_slot = "7973859818";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<acript type="text/javascript"
src="../../../../pagead2.googlesyndication.com/pagead/show_ads.js">
</script></div>
<div id="I_nav">
<div class="sect root">
<h3><b><a href="../../../default.htm">C++</a></b></h3>
<ul>
<li class="folder info"><a href="../../../info/default.htm">Information</a></li>
<li class="folder doc"><a href="../../../doc/default.htm">Tutorials</a></li>
<li class="folder reference"><a href="../../../reference/default.htm">Reference</a></li>
<li class="folder articles"><a href="../../../articles/default.htm">Articles</a></li>
<li class="folder selected forum"><a href="../../default.htm">Forum</a></li>
</ul>
</div>
<div class="sect">
<h3><b><a href="../../default.htm">Forum</a></b></h3>
<ul>
<li><a href="../../beginner/default.htm"><b>Beginners</b></a></li><li class="selected"><a href="../default.htm"><b>Windows Programming</b></a></li><li><a href="../../unices/default.htm"><b>UNIX/Linux Programming</b></a></li><li><a href="../../general/default.htm"><b>General C++ Programming</b></a></li><li><a href="../../lounge/default.htm"><b>Lounge</b></a></li><li><a href="../../jobs/default.htm"><b>Jobs</b></a></li></ul>
</div>
<div id="I_subnav"></div>
<div class="C_ad234">
<script type="text/javascript"><!--
google_ad_client = "ca-pub-7688470879129516";
google_ad_slot = "7445514729";
google_ad_width = 234;
google_ad_height = 60;
//-->
</script>
<acript type="text/javascript"
src="../../../../pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div></div>
<div id="I_midclear"></div>
</div>
</div>
<div id="I_bottom">
<div id="I_footer">
	<a href="../../../default.htm">Home page</a> | <a href="../../../privacy.do.htm">Privacy policy</a><br>&copy; cplusplus.com, 2000-2014 - All rights reserved - <i>v3.1</i><br><a href="../../../contact.doreferrerwww.cplusplus~506.com_">Spotted an error? contact us</a>
</div>
</div>

<script type="text/javascript">
<!--
function NavFor(us) {document.getElementById('I_subnav').innerHTML=us.ok?'<div class="sect"><h3><b><a href="../../../user/default.htm">'+us.user+'</a></b></h3><ul><li><a href="../../myposts.cgi.htm">My topics</a></li></ul></div>':'';}onSession(NavFor);ready();
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-521783-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? '../../../../httpsssl/default.htm' : '../../../../www/default.htm') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

//-->
</script>

</body>
</html>